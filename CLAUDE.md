# CLAUDE.md

Claude Code-like coding agent running on Databricks Apps. Turborepo monorepo with React + Fastify + Claude Agent SDK.

## Quick Start

```bash
cd app
npm install
npm run dev          # Frontend :5173, Backend :8000
npm run build        # Build all packages
npm run format       # Format code
npm run db:generate  # Generate migration from schema changes
```

## Architecture

```
app/
├── frontend/   # React + Vite + Ant Design v5
├── backend/    # Fastify + WebSocket + Claude Agent SDK
│   ├── agent/  # Claude Agent SDK config, MCP servers
│   ├── db/     # Drizzle ORM (PostgreSQL)
│   ├── models/ # Domain models (User, Session, ClaudeSettings)
│   ├── services/ # Business logic with external communication
│   └── routes/ # REST API + WebSocket
└── shared/     # Shared types (@app/shared)
```

### Models Layer Design

Models are pure domain objects. Allowed operations:

| Operation | Allowed | Example |
|-----------|---------|---------|
| ID generation/parsing | ✅ | `TypeID`, `UUID` |
| Computed properties | ✅ | `localPath`, `appName` |
| File system operations | ✅ | `ensureLocalDir()` (no external communication) |
| DB operations | ❌ | → `db/*.ts` |
| API/HTTP calls | ❌ | → `services/*.ts` |

**Key Models:**
- `Session` - TypeID-based session with computed paths (`localPath`, `appName`, `gitBranch`)
- `User` / `RequestUser` - User info extraction from headers, path generation
- `ClaudeSettings` - Claude Code hooks configuration generation

## Critical Patterns

### Auth: PAT-first + SP fallback
Uses user's PAT if available, otherwise falls back to Service Principal.
- `getAccessTokenForUser()` in `utils/auth.ts`
- Agent env vars configured in `agent/index.ts`

### PAT Encryption (AES-256-GCM)
User PATs are encrypted at rest using AES-256-GCM via Drizzle CustomType.

**Setup:**
```bash
# Generate a 32-byte key (64 hex chars)
openssl rand -hex 32

# Set as environment variable or Databricks secret
export ENCRYPTION_KEY=<64-char-hex-string>
databricks secrets put-secret claude-agent encryption-key
```

**Error Handling Strategy:**

| Scenario | Behavior |
|----------|----------|
| `ENCRYPTION_KEY` not set | PAT feature disabled, warning logged at startup |
| Key format invalid | PAT feature disabled, error logged at startup |
| Key changed after PATs stored | Decryption fails gracefully, PAT treated as "not set" |
| Decryption failure | Warning logged, user prompted to re-configure PAT |

**Key Files:**
- `utils/encryption.ts` - AES-256-GCM encrypt/decrypt helpers
- `db/customTypes.ts` - `encryptedText` Drizzle CustomType
- `db/schema.ts` - `oauth_tokens.access_token` uses `encryptedText`
- `services/userService.ts` - `getUserPersonalAccessToken()` handles errors

### User Model
Extracts user info from headers. Access paths via `user.local.*` / `user.remote.*`.
```typescript
const user = User.fromHeaders(request.headers);
// user.local.claudeConfigDir → $HOME/users/{name}/.claude
// user.remote.claudeConfigDir → /Workspace/Users/{email}/.claude
```

### DB: Row Level Security
`sessions`, `settings`, `oauth_tokens` have RLS enabled. Always wrap queries:
```typescript
await withUserContext(db, userId, async () => { /* queries */ });
```

### Frontend State
Don't call same API from multiple components. Use Context:
- `UserContext` - User info + settings
- `SessionsContext` - Session list (client-side filtering)

### Workspace Sync
Auto-sync via Claude Code hooks (`settings.json`). Generated by ClaudeSettings model in `models/ClaudeSettings.ts`.
- SessionStart: Workspace → Local (pull)
- Stop: Local → Workspace (push, conditional)

## Naming Conventions

- DB/API: `snake_case` (`databricks_workspace_path`, `is_archived`)
- TypeScript: `camelCase` (`databricksWorkspacePath`, `isArchived`)
- Session ID: TypeID format (`session_01h455vb4pex5vsknk084sn02q`)
- App name: `claude-{uuidv7}` (e.g., `claude-01h455vb4pex5vsknk084sn02q`)

## Common Gotchas

1. **Drizzle v1.0+**: Use `drizzle({ client })` syntax (not `drizzle(client)`)
2. **MCP tool names**: Prefixed with `mcp__` in frontend
3. **Session interrupt**: Must save `result` event with `subtype: "interrupted"` (required for UI state)
4. **Migrations**: Auto-run on server startup

## UI/Design

- Brand: `#f5a623`
- Font: Noto Sans JP
- Icons: `@ant-design/icons`
- i18n: `react-i18next` (`en`, `ja`)

## Deployment

```bash
databricks bundle deploy -t dev   # Development
databricks bundle deploy -t prod  # Production
```

Secrets: `databricks secrets put-secret claude-agent database-url`
